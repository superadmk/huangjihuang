var bizFilter = {
    bizCateHtml: [],
    bizAttHtml: [],
    req_url: "category.php",
    filterElemId: "filter_content",
    _nodeDepth: 0,
    otherAtts: [],
    atts: [],
    currentAtts: [],
    params: [],
    canceled: !1,
    closeDivCount: 0,
    radioArr: {
        hasStock: "is_stock",
        displaySalesPromotion: "is_promo",
        displayOutlets: "is_outlets",
        displayMVip: "is_mvip",
        displayPreSell: "is_presell",
        displayDDSelf: "is_ddself",
        displayOverseas: "is_overseas"
    },
    init: function() {
        this.bindToggle($("#" + this.filterElemId));
        this.bindPriceFocus();
        this.initDom();
        this.bindGetSubCategories();
        this.bindRadioClick();
        this.bindAttClick();
        this.bindAddClick();
        this.bindCancelClick();
        this.bindSubmitClick();
        this.initDivFixed();
        this.bindBackClick()
    },
    bindBackClick: function() {
        var a = document.referrer, b = window.location.href, c = this;
        - 1 != a.indexOf("ddcategory.php") ? $.cookie("_last_jumping_url", a, {
            expires: 1
        }) : this.validRedirectLoc(a) && $.cookie("_last_jumping_url", a, {
            expires: 1
        });
        $("a.search_back, a.xph_back").click(function() {
            b == $.cookie("_last_jumping_url") ? null != a ? (a = c.addSid(a), window.location.href = c.validRedirectLoc(a) ?
                a : c.addSid(ddTouchIndex)) : window.location.href = c.addSid(ddTouchIndex) : $.cookie("_last_jumping_url") ? window.location.href = c.addSid($.cookie("_last_jumping_url")) : window.location.href = c.addSid(ddTouchIndex)
        })
    },
    validRedirectLoc: function(a) {
        return !( - 1 != a.indexOf("search.php")||-1 != a.indexOf("category.php"))
    },
    addSid: function(a) {
        return - 1 == a.indexOf("sid=") ? a + "?sid=" + sid : a
    },
    initDivFixed: function() {
        var a = this, b = function() {
            "none" != $("._next").css("display") && $("div.filtrate_category").each(function() {
                "none" !=
                $(this).next().css("display") && $(this).children("a").hasClass("filtrate_category_show") && a.divSticky($(this))
            })
        };
        $(document).bind("touchmove", b);
        $(window).scroll(b)
    },
    divSticky: function(a) {
        var b = $(window).scrollTop(), c = a.next(), f = parseInt(c.offset().top) - parseInt(a.height()), d = parseInt(c.height()) + parseInt(c.offset().top) - parseInt(a.height());
        b > f && b < d ? a.hasClass("fixed") || (a.attr("style", "").addClass("fixed"), c.css("margin-top", a.height()), a.css("top", "0")) : a.hasClass("fixed") && (a.removeClass("fixed"),
            c.css("margin-top", 0))
    },
    initDom: function() {
        var a = this.getQuerystringObj();
        this.req_url = 0 < window.location.href.indexOf("search.php") ? "search.php" : "category.php";
        "undefined" != typeof a.cid && "" != a.cid && (!1 !== a.cid.indexOf(".") && (a.cid = a.cid.replaceAll(".", "_")), $("a[cid=" + a.cid + "]", $("#filter_category_list")).addClass("on"));
        for (var b in this.radioArr)
            "undefined" != typeof a[this.radioArr[b]] && 1 == a[this.radioArr[b]] && $("#" + b).addClass("on");
        "undefined" != typeof a.lp && $("#lp", $("#filter_content")).val(a.lp);
        "undefined" != typeof a.hp && $("#hp", $("#filter_content")).val(a.hp);
        this.partShow()
    },
    partShow: function() {
        var a = $("#filter_category_list"), b = $("#filter_1_list"), c = $("#filter_region_list");
        a.show().find("li").slice(4).hide();
        0 == b.children("li.on").length && b.show().children("li").slice(12).hide();
        0 == c.children("li.on").length && c.show().children("li").slice(12).hide()
    },
    brandPartShow: function() {
        $("#filter_1_list").show().children("li").slice(12).hide()
    },
    bindCancelClick: function() {
        var a = this;
        $("#clear_btn").click(function() {
            a.removeAttOnState();
            $("span.up_down").not(":first-of-type").each(function() {
                "\u5168\u90e8\u5c55\u5f00" != $(this).html() && $(this).html("\u5168\u90e8")
            });
            $(".filtrate_category_show").click();
            $("#lp").val("");
            $("#hp").val("");
            for (var b in a.radioArr)
                $("#" + b).removeClass("on");
            b = "undefined" != typeof a.params.cid ? a.params.cid : "";
            a.params = [];
            b && (a.params.cid = b);
            a.otherAtts = [];
            a.canceled=!0
        })
    },
    bindSubmitClick: function() {
        var a = this;
        $("#submit_btn").click(function() {
            var b = a.getQuerystringObj();
            a.getSelectedAtt();
            var c = [], f = 0, d =
                [], g = "is_stock is_promo is_outlets is_mvip is_presell is_ddself is_overseas".split(" ");
            for (e in b)
                if (a.canceled) {
                    if ("keyword" == e || "sid" == e || "req" == e || "cid" == e || "promotion_id" == e)
                        d[e] = b[e]
                } else
                    $.inArray(e, g) && 0 == b[e] || "from" != e && "no_ad" != e && (d[e] = b[e]);
            for (e in a.params)
                d[e] = a.params[e];
            "undefined" == typeof a.params.city && "undefined" != typeof d.city && delete d.city;
            "undefined" == typeof a.params.brand && "undefined" != typeof d.brand && delete d.brand;
            "undefined" != typeof d.brand && 0 == d.brand.length && delete d.brand;
            for (var e in a.radioArr)
                0 == d[a.radioArr[e]] && delete d[a.radioArr[e]];
            "" != $("#lp").val() ? d.lp = $("#lp").val() : delete d.lp;
            "" != $("#hp").val() ? d.hp = $("#hp").val() : delete d.hp;
            b = "?";
            for (e in d)
                "att" != e && ("cid" == e && (d[e] = d[e].replaceAll("_", ".")), "brand" == e && $.isArray(d[e]) && (d[e] = d[e].join(",")), "keyword" != e && "sid" != e && "req" != e && "cid" != e && "from" != e && "sort_type" != e && "no_ad" != e && "promotion_id" != e && (c[e] = d[e], f++), b += e + "=" + d[e] + "&");
            b = b.substr(0, b.length - 1);
            0 < a.getAsocArrSize(a.otherAtts) && (b += "&att=" + a.getOtherAttsStr(),
                f++);
            b += 0 == f || 1 == f && 1 == c.is_stock ? "" : "&no_ad=1";
            window.location.href = searchUrl + a.req_url + (b + "&from=filter");
            return !1
        })
    },
    bindRadioClick: function() {
        var a = this, b = $("div.filtrate_has>ul>li");
        hasFilter || (a.params.is_stock = 1);
        b.click(function() {
            var b = $(this).hasClass("on") ? 0: 1;
            $(this).toggleClass("on");
            var f = $(this).attr("id");
            a.params[a.radioArr[f]] = b
        })
    },
    getSelectedAtt: function() {
        var a = this;
        $("ul.att_item>li,ul.addr_item>li").each(function() {
            if ($(this).hasClass("on")) {
                var b = $(this).children("a").attr("cid"),
                    c = $(this).parent().prev().attr("att_id");
                1 == c ? ($.isArray(a.params.brand) || (a.params.brand = []), - 1 == a.params.brand.indexOf(b) && a.params.brand.push(b)) : "address" == c ? a.params.city = b : ($.isArray(a.otherAtts[c]) || (a.otherAtts[c] = []), - 1 == a.otherAtts[c].indexOf(b) && a.otherAtts[c].push(b))
            }
        })
    },
    bindAttClick: function() {
        $("ul.att_item>li").click(function() {
            $(this).toggleClass("on")
        })
    },
    bindAddClick: function() {
        $("ul.addr_item>li").click(function() {
            $(this).toggleClass("on");
            $(this).siblings().removeClass("on")
        })
    },
    getAttNameStr: function(a) {
        var b = [];
        a.find("li").each(function() {
            var a = $(this).children("a");
            if ($(this).hasClass("on") || a.hasClass("on"))
                null != a.attr("cname") ? b.push(a.attr("cname")) : b.push(a.attr("aname"))
        });
        a = b.join(",");
        return 0 == b.length ? "\u6536\u8d77" : a
    },
    removeOnState: function() {
        $("a", $("#filter_category_list")).removeClass("on")
    },
    removeAttOnState: function(a) {
        "undefined" != typeof a ? (a = a.parent().parent(), $("li", a).removeClass("on")) : ($("li", $(".att_item")).removeClass("on"), $("li", $(".addr_item")).removeClass("on"))
    },
    getOtherAttsStr: function() {
        var a = [], b;
        for (b in this.otherAtts) {
            var c = b.replaceAll("'", "");
            if ($.isArray(this.otherAtts[b]))
                for (var f in this.otherAtts[b]) {
                    var d = c + ":" + this.otherAtts[b][f];
                    - 1 == a.indexOf(d) && a.push(d)
                }
        }
        return 0 < a.length ? a.join("-") : ""
    },
    bindGetSubCategories: function() {
        var a = this;
        $("#" + this.filterElemId).children(".filtrate_list").eq(0);
        var b = $(".filtrate_price");
        $("#filter_category_list").click(function(c) {
            var f = $(c.target);
            f.is("span") && (f = f.parent());
            var d = f.hasClass("on");
            a.removeOnState();
            f.addClass("on");
            var g = f.attr("cid");
            a.params.cid = g;
            if (f.hasClass("filtrate_list_li_a") && f.hasClass("open"))
                f.removeClass("open"), "undefined" != typeof a.bizCateHtml[g] && (f.next("ul").remove(), d || (a.removeAllAtts(), $(a.bizAttHtml[g].brand).insertBefore(b), $(a.bizAttHtml[g].att).insertAfter(b), a.params.brand = "", a.otherAtts = [], a.bindAttToggle(), a.bindAttClick(), a.brandPartShow()));
            else if (f.hasClass("filtrate_list_li_a")&&!f.hasClass("open")) {
                if ("undefined" == typeof g ||!g)
                    return !1;
                c = a.getQuerystringObj();
                c.keyword && (c.keyword = decodeURIComponent(c.keyword));
                c.cid = g.replaceAll("_", ".");
                c.act = "get_sub_categories";
                if ("undefined" != typeof a.bizCateHtml[g])
                    return f.next("ul").remove(), f.addClass("open"), $(a.bizCateHtml[g]).insertAfter(f), d || (a.removeAllAtts(), $(a.bizAttHtml[g].brand).insertBefore(b), $(a.bizAttHtml[g].att).insertAfter(b), a.params.brand = "", a.otherAtts = [], a.bindAttToggle(), a.bindAttClick(), a.brandPartShow()), !0;
                $.ajax({
                    type: "GET",
                    url: searchUrl + a.req_url,
                    data: c,
                    dataType: "json",
                    success: function(c) {
                        if (null !=
                            c) {
                            var h = "", k = a.getAttsHtml(c.att, g);
                            0 == c.category.length ? a.params.cid = g : (f.addClass("open"), h = a.getCategoriesHtml(c.category, f), f.next("ul").remove(), $(h).insertAfter(f));
                            d || (a.removeAllAtts(), $(k.brand).insertBefore(b), $(k.att).insertAfter(b), a.params.brand = "", a.otherAtts = [], a.bizCateHtml[g] = h, a.bizAttHtml[g] = k, a.bindAttToggle(), a.bindAttClick(), a.brandPartShow())
                        }
                    }
                })
            }
        })
    },
    bindPriceFocus: function() {
        $("div.filtrate_price").children("input").focus(function() {
            $(this).toggleClass("foucs")
        }).blur(function() {
            $(this).toggleClass("foucs")
        })
    },
    bindToggle: function(a) {
        var b = this;
        $(".filtrate_category,.filtrate_category_a", a).click(function() {
            $(this).hasClass("filtrate_category_show") ? ($(this).parent().removeClass("fixed"), $(this).parent().next(".filtrate_list").css("margin-top", "0").hide(), $(this).removeClass("filtrate_category_show"), $(this).children("span").text(b.getAttNameStr($(this).parent().next(".filtrate_list"))), "\u6536\u8d77" == $(this).children("span").html() && $(this).children("span").html("\u5168\u90e8")) : ($(this).parent().removeClass("fixed"),
                $(this).parent().next(".filtrate_list").show(), $(this).addClass("filtrate_category_show"), $(this).children("span").html("\u6536\u8d77"), $(this).parent().next(".filtrate_list").find("li").show())
        })
    },
    bindAttToggle: function() {
        this.bindToggle($("div[att_id]").not("[att_id='address']"));
        this.bindToggle($("ul.att_item"))
    },
    removeAllAtts: function() {
        for (var a = $("#" + this.filterElemId).children(".filtrate_category"), b = 0; b < a.length; b++) {
            var c = $(a[b]).next();
            0 != b && b != a.length - 1 && ($(a[b]).remove(), c.remove())
        }
    },
    getQuerystringObj: function() {
        var a = {}, b = window.location.search.slice(1).split("&");
        for (i in b) {
            var c = b[i].split("=");
            a[decodeURIComponent(c[0])] = c[1]
        }
        return a
    },
    getCategoriesHtml: function(a, b) {
        if (0 == a.length)
            return "";
        var c = "<ul>", f = parseInt(b.css("padding-left").replace("px", ""));
        if ("undefined" != typeof a)
            for (i in a)
                c += '<li class="filtrate_list_li"><a style="padding-left:' + (f + 20) + 'px" class="filtrate_list_li_a" cid="' + a[i].cid + '" cname="' + a[i].cname + '" href="javascript:;">' + a[i].cname + "</a></li>";
        return c +
            "</ul>"
    },
    getAttsHtml: function(a, b) {
        if (null == a || 0 == a.length)
            return "";
        var c = [], f = {
            brand: "",
            att: ""
        };
        if ("undefined" != typeof a)
            for (i in a) {
                var d = "", g = a[i].items;
                c.push(a[i].id);
                var e = 1 == a[i].id ? "\u5168\u90e8\u5c55\u5f00": "\u5168\u90e8", d = d + ('<div class="filtrate_category" att_id="' + a[i].id + '"><a class="filtrate_category_a" href="javascript:;">' + a[i].name);
                if (0 == g.length)
                    d += "</a></div>";
                else {
                    d += '<span class="up_down">' + e + "</span></a></div>";
                    d += '<ul class="clearfix filtrate_address filtrate_list att_item" id="filter_' +
                        a[i].id + '_list">';
                    for (j in g)
                        d += '<li><a href="javascript:;" cid="' + g[j].id + '" aname="' + g[j].name + '">' + g[j].name + "</a></li>";
                    d += "</ul>"
                }
                1 == a[i].id ? f.brand = d : f.att += d
            }
        this.currentAtts = c;
        this.atts[b] = c;
        return f
    },
    getAsocArrSize: function(a) {
        var b = 0;
        for (key in a)
            a.hasOwnProperty(key) && b++;
        return b
    }
};
